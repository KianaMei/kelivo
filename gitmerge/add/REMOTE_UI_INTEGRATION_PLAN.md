# 远程 UI 融合计划（草案）

目标：在不破坏现有体验的前提下，逐步引入 kelivo-remote 的 UI 能力，默认行为保持现状，通过设置开关与平台隔离按需启用。

核心准则：
- Never break userspace：默认不改变现有外观与行为；新增能力均为“默认关闭 + 平台受限”。
- 简化数据结构：优先在 SettingsProvider 内集中建模，减少分散判断与特殊分支。
- 分阶段上线：先低风险、弱耦合功能；后高耦合、平台相关功能；随阶段验证。
- 不在本计划阶段提交 git 或运行完整构建（仅计划与清单）。

优先级与范围（对应你的 ①～⑧）：

1) 主题/字体（优先级：中→高；目标：与远程一致，默认外观不变）
- 目标：支持系统字体预加载与 Google Fonts 可选，全局应用字体；保持现有字体回退策略。
- 交付标准：不开启时，UI 外观与当前版本一致；开启后，字体选择在设置中生效且可回退。
- 任务：
  - 引入“应用字体/代码字体”设置键（默认空/关闭）。
  - 接入系统字体预加载与 Google Fonts（仅在开启时生效）。
  - 主题工厂中统一挂载字体（标题/正文/AppBar）。

2) 设置页扩展（优先级：低）
- 目标：保持远程的独立设置页（字体选择页、网络代理页等），但先不默认展示或不接电；后续再逐项对接。
- 交付标准：页面可独立打开（隐藏入口或开发入口），不影响既有设置功能。
- 任务：
  - 引入字体选择页与网络代理页（入口暂隐藏/标注实验特性）。
  - SettingsProvider 对应键先占位，后续按需要逐项接电。

3) 桌面端优化（优先级：高；细化稍后）
- 目标：引入远程的桌面交互元素（Popover/对话框/面板等），强化 Desktop 体验；对移动端零影响。
- 交付标准：仅 Desktop 平台启用；不开启或非桌面平台时行为与现状一致。
- 任务：
  - 迁入桌面弹窗/Popover/面板组件；以平台检测与开关保护。
  - 与现有 Desktop 导航/窗口控制对齐，避免命名冲突与重复能力。

4) 聊天渲染（优先级：高；与 3 同步推进）
- 目标：支持内联思维块与更丰富的表情文本渲染；默认关闭或折叠，避免改变既有展示。
- 交付标准：不开启时展示与当前一致；开启后新能力以可见但安全的方式呈现（例如思维块默认折叠）。
- 任务：
  - 引入思维块解析与 UI；增加“自动折叠/展开”设置项（默认折叠/关闭）。
  - 引入增强的表情文本渲染组件（默认关闭）。

5) 翻译功能（优先级：中；直接使用远程方案）
- 目标：提供独立“翻译”页面（模型与语言可选、流式显示）。
- 交付标准：页面可从二级入口访问（避免干扰主流程），本地化与主题适配正常。
- 任务：
  - 迁入翻译页面与语言选择逻辑；接入现有模型/Provider 配置读取。
  - 在设置或更多菜单中放置入口（默认隐藏或标记为实验）。

6) 通知与后台（Android）（优先级：中；直接模仿远程）
- 目标：按设置启用后台运行与本地通知；默认关闭，显式授权与初始化。
- 交付标准：Android 平台在开启后可工作；未开启/非 Android 平台无任何影响。
- 任务：
  - 迁入后台与通知服务封装；增加设置项与首次授权流程。
  - 根据模式（关闭/通知提示等）控制开启逻辑。

7) 资产（优先级：后续再议）
- 目标：统一远程 HTML 模板与本体贴纸等资源的策略（是否保留、按平台裁剪）。
- 任务：
  - 列表化两边的资源差异；评估体积/许可/平台适配；制定最小集与可选包。

8) 依赖取向（优先级：后续再议）
- 目标：按阶段引入远程的 UI 相关依赖（字体、拖拽、WebView、PDF、后台、通知等）。
- 原则：逐项引入、平台隔离、构建可控；必要时条件导入/特性开关。

分阶段里程碑（建议）：
- Phase A（低风险先行）：翻译页面（5）；字体/主题骨架与设置占位（1,2，不接电/默认关）。
- Phase B（桌面能力）：桌面 Popover/对话框/面板（3）；聊天渲染增强（4），全程默认关闭或仅 Desktop 生效。
- Phase C（平台特性）：Android 后台与通知（6），默认关闭 + 权限显式请求。
- Phase D（收尾）：资产与依赖的统一治理（7,8），按平台裁剪与许可证检查。

风险与对策：
- 构建/平台不兼容：所有平台相关能力加“平台检测 + 条件启用”，必要时条件导入，避免波及移动端与 Web。
- 默认行为改变：所有新增能力默认关闭；设置迁移保持既有键值；必要时新增版本化键避免覆盖旧值。
- 命名/职责冲突：迁入组件先隔离命名空间，逐步合并能力，避免双份实现并存。

首批文件迁移清单（不接电，仅占位/准备）：
- 主题/字体：字体选择页面（Google Fonts 选择器）；系统字体预加载逻辑；主题挂载点。
- 设置页扩展：网络代理页；字体选择页（入口暂隐藏）。
- 桌面端优化：桌面弹窗/Popover/对话框/面板组件集合（仅 Desktop 平台启用）。
- 聊天渲染：思维块渲染组件与表情文本组件（默认关闭/折叠）。
- 翻译功能：翻译页面与语言选择逻辑（二级入口）。
- 通知后台（Android）：后台管理与通知服务封装（默认关闭，权限显式）。

验收清单（阶段性）：
- 默认不开启任何新增能力时，App 外观与行为与当前一致。
- 在 Windows 桌面开启桌面能力后，新增组件工作正常；Android 默认无变更，开启后台后工作正常。
- 字体设置开启时，切换字体即时生效且可回退；关闭后恢复默认。
- 翻译页面可从二级入口访问，功能完整，关闭后不影响主流程。

备注：本文件仅为计划与清单，不包含代码接线与构建步骤，遵守“禁止私自提交 git 和私自运行完整构建”的约束。

