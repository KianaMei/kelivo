name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      new_build: ${{ steps.bump.outputs.new_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.repository.default_branch }}

      - name: Bump version number
        id: bump
        run: |
          # Read current version from pubspec.yaml
          current=$(grep -E '^version:' pubspec.yaml | sed 's/version: //')
          echo "Current version: $current"
          
          # Split into version and build number
          version_part=$(echo "$current" | cut -d'+' -f1)
          build_part=$(echo "$current" | cut -d'+' -f2)
          
          # Split version into major.minor.patch
          major=$(echo "$version_part" | cut -d'.' -f1)
          minor=$(echo "$version_part" | cut -d'.' -f2)
          patch=$(echo "$version_part" | cut -d'.' -f3)
          
          # Increment patch by 1
          new_patch=$((patch + 1))
          new_build=$((build_part + 1))
          
          new_version="${major}.${minor}.${new_patch}"
          full_version="${new_version}+${new_build}"
          
          echo "New version: $full_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_build=$new_build" >> $GITHUB_OUTPUT
          
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $full_version/" pubspec.yaml
          
          # Update msix_version (format: X.X.X.0)
          msix_version="${major}.${minor}.${new_patch}.0"
          sed -i "s/msix_version: .*/msix_version: $msix_version/" pubspec.yaml
          
          echo "Updated pubspec.yaml:"
          grep -E '^version:|msix_version:' pubspec.yaml

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore: bump version to $(grep -E '^version:' pubspec.yaml | sed 's/version: //') [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.event.repository.default_branch }}

  create-release:
    needs: bump-version
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true

  build-android:
    name: Build Android
    needs: [bump-version, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with latest version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.event.repository.default_branch }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          # Use latest stable that includes Dart >= 3.7 (mcp_client requirement)
          flutter-version: '3.35.7'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Clean old signing files
        run: |
          echo "Cleaning old signing files..."
          rm -f android/key.properties
          rm -f android/upload-keystore.jks
          rm -f android/app/upload-keystore.jks
          rm -f android/app/key.properties
          echo "Cleanup complete"

      - name: Setup Android signing
        continue-on-error: true
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "No keystore configured, will build unsigned APK"
            exit 0
          fi

          echo "Setting up keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/upload-keystore.jks

          echo "Creating key.properties..."
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF

          echo "Keystore setup complete!"
          echo "Keystore file location:"
          ls -lh android/upload-keystore.jks
          echo ""
          echo "key.properties content:"
          cat android/key.properties
          echo ""
          echo "Current directory structure:"
          ls -la android/ | head -20

      - name: Build APK
        run: |
          echo "Building APK..."
          if [ -f "android/key.properties" ]; then
            echo "Building SIGNED APK..."
          else
            echo "Building UNSIGNED APK (no keystore found)..."
          fi
          flutter build apk --release --split-per-abi --no-tree-shake-icons
        continue-on-error: false

      - name: Build App Bundle
        run: |
          echo "Building App Bundle..."
          if [ -f "android/key.properties" ]; then
            echo "Building SIGNED App Bundle..."
          else
            echo "Building UNSIGNED App Bundle (no keystore found)..."
          fi
          flutter build appbundle --release --no-tree-shake-icons
        continue-on-error: false

      - name: Rename APK files
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed 's/app-/kelivo-/')
              mv "$file" "$newname"
              echo "Renamed: $file -> $newname"
            fi
          done
          ls -lh

      - name: Rename AAB file
        run: |
          cd build/app/outputs/bundle/release
          if [ -f "app-release.aab" ]; then
            mv app-release.aab kelivo-release.aab
            echo "Renamed: app-release.aab -> kelivo-release.aab"
          fi
          ls -lh

      - name: Upload APKs to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/app/outputs/flutter-apk/kelivo-*.apk
            build/app/outputs/bundle/release/kelivo-release.aab

  build-windows:
    name: Build Windows
    needs: [bump-version, create-release]
    runs-on: windows-latest
    steps:
      - name: Checkout code with latest version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.event.repository.default_branch }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.35.7'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Generate required files
        shell: pwsh
        run: |
          Write-Host "Generating Hive adapters and other generated files..."
          flutter pub run build_runner build --delete-conflicting-outputs
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Build runner completed with warnings, continuing..."
          }

      - name: Disable flutter_tts for Windows
        shell: pwsh
        run: |
          Write-Host "Disabling flutter_tts plugin for Windows build..."
          $pubspecPath = "pubspec.yaml"
          $content = Get-Content $pubspecPath -Raw
          
          # Robustly comment the flutter_tts line (anchor at start-of-line, preserve indent)
          $updated = [System.Text.RegularExpressions.Regex]::Replace(
            $content,
            '^(?<indent>\s*)flutter_tts\s*:(?<rest>.*)$',
            '${indent}# flutter_tts:${rest}  # Disabled for Windows build',
            [System.Text.RegularExpressions.RegexOptions]::Multiline
          )
          if ($updated -ne $content) {
            Set-Content $pubspecPath $updated
            Write-Host "Updated pubspec.yaml (flutter_tts commented)"
          } else {
            Write-Host "No flutter_tts line found to comment (already disabled?)"
          }

          # Ensure stale plugin symlinks are removed then resolve deps
          flutter clean
          flutter pub get

      - name: Build Windows app
        run: flutter build windows --release --no-tree-shake-icons

      - name: Build MSIX installer
        continue-on-error: true
        shell: pwsh
        run: |
          Write-Host "Building MSIX installer..."
          flutter pub run msix:create
          
          # Verify MSIX was created
          $msixFiles = Get-ChildItem -Path "build\windows\x64\runner\Release" -Filter "*.msix" -Recurse
          if ($msixFiles) {
            foreach ($msix in $msixFiles) {
              Write-Host "✓ MSIX created: $($msix.FullName)"
              $msixSize = $msix.Length / 1MB
              Write-Host "  Size: ${msixSize:N2} MB"
              
              # Copy to root for easier upload
              Copy-Item $msix.FullName -Destination "kelivo-windows-installer.msix" -Force
            }
          } else {
            Write-Host "⚠ Warning: No MSIX file found, continuing with portable only..."
          }

      - name: Get version number
        shell: pwsh
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern "version:" | ForEach-Object { $_.Line.Split(":")[1].Trim().Split("+")[0] })
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Version: $version"

      - name: Create portable package
        shell: pwsh
        run: |
          Write-Host "Creating Windows portable package..."
          
          # Find the build output directory
          $buildPath = "build\windows\x64\runner\Release"
          
          if (-not (Test-Path $buildPath)) {
            Write-Host "ERROR: Build path not found: $buildPath"
            Write-Host "Searching for .exe files..."
            $exeFiles = Get-ChildItem -Path "build\windows" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles) {
              foreach ($exe in $exeFiles) {
                Write-Host "Found: $($exe.FullName)"
                $buildPath = Split-Path $exe.FullName -Parent
                break
              }
            } else {
              throw "No executable files found!"
            }
          }
          
          Write-Host "Build path: $buildPath"
          Write-Host "Contents:"
          Get-ChildItem -Path $buildPath | ForEach-Object {
            Write-Host "  $($_.Name) ($($_.Length) bytes)"
          }
          
          # Create output directory
          $outputDir = "kelivo-windows-x64"
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          # Copy all files
          Write-Host "`nCopying files to $outputDir..."
          Copy-Item -Path "$buildPath\*" -Destination $outputDir -Recurse -Force
          
          # Verify exe exists
          $exeFile = Get-ChildItem -Path $outputDir -Filter "*.exe" | Select-Object -First 1
          if (-not $exeFile) {
            throw "ERROR: No executable file found in output directory!"
          }
          Write-Host "Executable found: $($exeFile.Name)"
          
          # Create zip archive
          Write-Host "`nCreating zip archive..."
          Compress-Archive -Path $outputDir -DestinationPath "kelivo-windows-x64.zip" -Force
          
          if (-not (Test-Path "kelivo-windows-x64.zip")) {
            throw "ERROR: Failed to create zip file!"
          }
          
          $zipSize = (Get-Item "kelivo-windows-x64.zip").Length / 1MB
          Write-Host "✓ Created kelivo-windows-x64.zip (${zipSize:N2} MB)"

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Create Inno Setup installer
        shell: pwsh
        run: |
          Write-Host "Creating Inno Setup installer..."

          # Check for Chinese language file and download if missing
          $zhLangCompiler = "C:\Program Files (x86)\Inno Setup 6\Languages\ChineseSimplified.isl"
          $zhLangLocalDir = Join-Path (Get-Location) "Languages"
          $zhLangLocal = Join-Path $zhLangLocalDir "ChineseSimplified.isl"
          $languagesBlock = $null

          if (Test-Path $zhLangCompiler) {
            Write-Host "✅ Found Chinese language file: $zhLangCompiler"
            $languagesBlock = @"
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"
          "@
          } else {
            Write-Host "⚠️ Chinese language file not found in Inno Setup directory, attempting download..."
            try {
              New-Item -ItemType Directory -Force -Path $zhLangLocalDir | Out-Null
              $uri = 'https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/ChineseSimplified.isl'
              Invoke-WebRequest -Uri $uri -OutFile $zhLangLocal -UseBasicParsing -TimeoutSec 60
              if (Test-Path $zhLangLocal) {
                Write-Host "✅ Downloaded Chinese language file: $zhLangLocal"
                $languagesBlock = @"
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          Name: "chinesesimplified"; MessagesFile: "$zhLangLocal"
          "@
              }
            } catch {
              Write-Host "⚠️ Failed to download Chinese language file: $($_.Exception.Message)"
            }
            if (-not $languagesBlock) {
              Write-Host "ℹ️ Falling back to English-only installer"
              $languagesBlock = @"
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          "@
            }
          }

          # Create Inno Setup script
          $issContent = @"
          #define MyAppName "Kelivo"
          #define MyAppVersion "$env:VERSION"
          #define MyAppPublisher "Kelivo Team"
          #define MyAppExeName "kelivo.exe"

          [Setup]
          AppId={{K3L1V0-A1B2-C3D4-E5F6-123456789ABC}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=.
          OutputBaseFilename=kelivo-windows-{#MyAppVersion}-setup
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64
          ArchitecturesAllowed=x64
          UninstallDisplayIcon={app}\{#MyAppExeName}

          $languagesBlock

          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\Uninstall {#MyAppName}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "Launch {#MyAppName}"; Flags: nowait postinstall skipifsilent
          "@

          # Save with UTF-8 BOM for proper Chinese character handling
          $issContent | Out-File -FilePath "installer.iss" -Encoding utf8BOM

          # Compile installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"

          # Verify installer was created
          $installerFile = Get-ChildItem -Filter "kelivo-windows-*-setup.exe" | Select-Object -First 1
          if ($installerFile) {
            $installerSize = $installerFile.Length / 1MB
            Write-Host "✓ Created $($installerFile.Name) (${installerSize:N2} MB)"
          } else {
            throw "ERROR: Installer file not created!"
          }

      - name: Upload Windows build to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            kelivo-windows-x64.zip
            kelivo-windows-*-setup.exe
            kelivo-windows-installer.msix
